sudo bash -c 'cat >/srv/deploy/pull-deploy.sh' <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="/srv/deploy/proyecto-ubuntu"
WEB_DIR="/var/www/proyecto"
BRANCH="dev-app"
SUBDIR="Pagina1_IntegradorII"   # cambia si corresponde
LOG="/var/log/deploy-ubuntu.log"
APP_USER="grupo3"
SSH_KEY="/home/grupo3/.ssh/id_ed25519"

echo "==== DEPLOY $(date) ====" | tee -a "$LOG"

# Git con la llave del usuario grupo3 (NO root)
sudo -u "$APP_USER" -H env \
  GIT_SSH_COMMAND="ssh -i $SSH_KEY -o IdentitiesOnly=yes" \
  bash -lc "
    set -euo pipefail
    cd '$REPO_DIR'
    git remote -v
    git fetch origin
    git checkout '$BRANCH'
    git reset --hard 'origin/$BRANCH'
  "

SRC="$REPO_DIR/$SUBDIR"
if [ ! -d "$SRC" ]; then
  echo "ERROR: No existe la carpeta $SRC" | tee -a "$LOG"
  exit 1
fi

rsync -a --delete --exclude '.git' --exclude '.github' '$SRC/' '$WEB_DIR/' 2>&1 | tee -a "$LOG"

chown -R www-data:www-data "$WEB_DIR"
find "$WEB_DIR" -type f -exec chmod 0644 {} \;
find "$WEB_DIR" -type d -exec chmod 0755 {} \;

systemctl reload apache2 || true
echo "OK: Despliegue completado en $WEB_DIR" | tee -a "$LOG"
EOF

sudo chmod +x /srv/deploy/pull-deploy.sh
