sudo bash -c 'cat >/srv/deploy/pull-deploy.sh' <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="/srv/deploy/proyecto-ubuntu"
WEB_DIR="/var/www/proyecto"
BRANCH="dev-app"
SUBDIR="Pagina1_IntegradorII"   # carpeta del proyecto dentro del repo
LOG="/var/log/deploy-ubuntu.log"
APP_USER="grupo3"

echo "==== DEPLOY $(date) ====" | tee -a "$LOG"

# Asegura repo en la versiÃ³n remota exacta (como usuario normal con la llave)
sudo -u "$APP_USER" -H bash -lc "
  set -euo pipefail
  cd \"$REPO_DIR\"
  git fetch origin
  git checkout \"$BRANCH\"
  git reset --hard \"origin/$BRANCH\"
"

SRC="$REPO_DIR/$SUBDIR"
if [ ! -d "$SRC" ]; then
  echo "ERROR: No existe la carpeta $SRC" | tee -a "$LOG"
  exit 1
fi

# Sincroniza hacia el DocumentRoot
rsync -a --delete --exclude ".git" --exclude ".github" "$SRC"/ "$WEB_DIR"/ 2>&1 | tee -a "$LOG"

# Permisos web
chown -R www-data:www-data "$WEB_DIR"
find "$WEB_DIR" -type f -exec chmod 0644 {} \;
find "$WEB_DIR" -type d -exec chmod 0755 {} \;

# Recarga Apache (por si aplica)
systemctl reload apache2 || true

echo "OK: Despliegue completado en $WEB_DIR" | tee -a "$LOG"
EOF

sudo chmod +x /srv/deploy/pull-deploy.sh
